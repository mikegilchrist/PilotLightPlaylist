#!/usr/bin/env python3
"""
Purpose:
    Provides utility functions for Spotify playlist backup, restore, and update
    operations including authentication and I/O with playlist files.

Usage:
    Imported by main playlist management scripts.

Input:
    - Spotify OAuth2 credentials from environment or `.env`
    - Playlist configuration dictionary
    - Backup or restore file(s)

Output:
    - Read/write CSVs of playlist contents
    - Interactions with Spotify Web API (unless in dry-run mode)

Date: 2025-09-16
Version: 1.5.1
Chat name: pilotlight-scraper
GPT Model: GPT-4
Attribution: Generated by Michael Gilchrist in collaboration with ChatGPT
"""

import csv
import os
from dotenv import load_dotenv
import yaml
import spotipy
from spotipy.oauth2 import SpotifyOAuth

load_dotenv()

def load_config(config_file="config.yaml"):
    with open(config_file, "r") as f:
        return yaml.safe_load(f)

def init_spotify():
    return spotipy.Spotify(auth_manager=SpotifyOAuth(scope="playlist-modify-public"))

def backup_playlist(sp, playlist_id, output_file):
    tracks = []
    results = sp.playlist_items(playlist_id)
    while results:
        for item in results["items"]:
            track = item["track"]
            if track:
                artist = track["artists"][0]["name"]
                name = track["name"]
                uri = track["uri"]
                tracks.append((artist, name, uri))
        if results.get("next"):
            results = sp.next(results)
        else:
            results = None
    with open(output_file, "w", newline="") as f:
        writer = csv.writer(f)
        writer.writerow(["Artist", "Title", "URI"])
        writer.writerows(tracks)

def restore_playlist(sp, playlist_id, input_file):
    uris = []
    with open(input_file, "r") as f:
        reader = csv.DictReader(f)
        for row in reader:
            if row.get("URI"):
                uris.append(row["URI"])
    # Clear playlist and re-add all items
    sp.playlist_replace_items(playlist_id, [])
    for i in range(0, len(uris), 100):
        sp.playlist_add_items(playlist_id, uris[i:i+100])

def update_playlist(sp, artists, playlist_cfg, artist_file, dry_run=False, verbose=False):
    """
    dry_run:
        If True, will log matches but skip actual Spotify playlist modifications.
    """
    if verbose or dry_run:
        print(f"{'[DRY RUN] ' if dry_run else ''}Searching for tracks for: {playlist_cfg['title']}")

    found_tracks = []
    with open(artist_file, "r") as f:
        for line in f:
            artist = line.strip()
            if not artist:
                continue
            result = sp.search(q=f"artist:{artist}", type="track", limit=1)
            tracks = result.get("tracks", {}).get("items", [])
            if tracks:
                found_tracks.append(tracks[0]["uri"])
                if verbose or dry_run:
                    print(f"  Found: {artist} âž” {tracks[0]['name']}")
            else:
                if verbose or dry_run:
                    print(f"  Not found: {artist}")

    if dry_run:
        print(f"[DRY RUN] Would update {playlist_cfg['title']} with {len(found_tracks)} tracks.")
        return

    # Clear and replace playlist contents
    sp.playlist_replace_items(playlist_cfg["id"], [])
    for i in range(0, len(found_tracks), 100):
        sp.playlist_add_items(playlist_cfg["id"], found_tracks[i:i+100])
    if verbose:
        print(f"Updated {playlist_cfg['title']} with {len(found_tracks)} track(s).")
