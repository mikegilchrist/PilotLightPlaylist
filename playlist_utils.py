#!/usr/bin/env python3
# Date: 2025-09-17
# Version: 1.5.6
# Purpose: Utilities for Spotify authentication, config loading, backup, and playlist updates
# Usage: Imported by create_pilotlight_playlist.py
# Input: YAML config, scraped artist data (CSV or line-based text)
# Output: Playlist backups and updates
# Chat name: PilotLight Playlist - Utilities
# GPT Model: OpenAI o4-mini
# Attribution: Generated by Michael Gilchrist in collaboration with ChatGPT

import os
import csv
from dotenv import load_dotenv
import yaml
import spotipy
from spotipy.oauth2 import SpotifyOAuth

load_dotenv()

def init_spotify():
    return spotipy.Spotify(auth_manager=SpotifyOAuth(
        scope="playlist-modify-public playlist-modify-private",
        cache_path=os.path.expanduser("~/.cache/spotify_token.json")
    ))

def load_config():
    with open("config.yaml", "r") as f:
        return yaml.safe_load(f)

def backup_playlist(sp, playlist_id, output_file):
    tracks = []
    results = sp.playlist_items(playlist_id)
    while results:
        for item in results["items"]:
            track = item["track"]
            if track:
                artist_names = ", ".join(a["name"] for a in track["artists"])
                title = track["name"]
                uri = track["uri"]
                tracks.append((artist_names, title, uri))
        if results["next"]:
            results = sp.next(results)
        else:
            break
    with open(output_file, "w", newline="") as f:
        writer = csv.writer(f)
        writer.writerow(["Artist", "Title", "URI"])
        writer.writerows(tracks)

def search_track(sp, artist, title):
    query = f"{artist} {title}"
    results = sp.search(q=query, type="track", limit=1)
    tracks = results.get("tracks", {}).get("items", [])
    if tracks:
        return tracks[0]["uri"]
    return None

def restore_playlist(sp, playlist_id, uris):
    sp.playlist_replace_items(playlist_id, uris[:100])
    for i in range(100, len(uris), 100):
        sp.playlist_add_items(playlist_id, uris[i:i + 100])

def update_playlist(sp, artists, playlist_cfg, output_file, dry_run=False, verbose=False):
    print(f"{'[DRY RUN] ' if dry_run else ''}Searching for tracks for: {playlist_cfg['name']}")
    print("  Not found: Artist,Title,URI")

    found_tracks = []
    found_rows = []

    for row in artists:
        if isinstance(row, str):
            parts = row.split(",", 2)
        else:
            parts = row

        if len(parts) < 2:
            continue

        artist = parts[0].strip()
        title = parts[1].strip()
        uri = parts[2].strip() if len(parts) == 3 else ""

        if uri.startswith("spotify:track:"):
            found_tracks.append(uri)
            found_rows.append((artist, title, uri))
            if verbose:
                print(f"{'[DRY RUN] ' if dry_run else ''}Using provided URI: {uri} for {artist} - {title}")
        else:
            result_uri = search_track(sp, artist, title)
            if result_uri:
                found_tracks.append(result_uri)
                found_rows.append((artist, title, result_uri))
                if verbose:
                    print(f"{'[DRY RUN] ' if dry_run else ''}Found URI: {result_uri} for {artist} - {title}")
            else:
                print(f"  Not found: {artist},{title},{uri}")

    if not dry_run:
        restore_playlist(sp, playlist_cfg["id"], found_tracks)

    with open(output_file, "w", newline="") as f:
        writer = csv.writer(f)
        writer.writerow(["Artist", "Title", "URI"])
        writer.writerows(found_rows)
